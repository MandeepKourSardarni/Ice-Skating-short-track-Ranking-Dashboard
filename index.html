<!DOCTYPE html>
<html>
<head>
<title>Ice Skating Short Track Ranking Dashboard</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>

/* -----------------------------------------------------------
   GLOBAL + BACKGROUND
------------------------------------------------------------ */
body {
    margin:0;
    padding:0;
    font-family:'Segoe UI', Arial, sans-serif;
    color:white;
    background:#001428;
}

.bg {
    background-image:url("https://github.com/MandeepKourSardarni/Ice-Skating-short-track-Ranking-Dashboard/blob/main/image.jpg");
    background-size:cover;
    background-position:center;
    background-attachment:fixed;
    position:fixed;
    inset:0;
    opacity:0.35;
    z-index:-3;
}

.bgOverlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,30,0.6);
    z-index:-2;
}

/* -----------------------------------------------------------
   HEADER
------------------------------------------------------------ */
.headerBar {
    width:95%;
    margin:25px auto 20px auto;
    padding:15px;
    text-align:center;
    background:rgba(255,255,255,0.06);
    border-radius:14px;
    backdrop-filter:blur(14px);
    box-shadow:0 0 18px rgba(0,120,255,0.45);
}

h1 {
    margin:0;
    font-size:26px;
    font-weight:700;
    text-shadow:0 0 16px rgba(0,160,255,0.9);
}

/* -----------------------------------------------------------
   CONTROL PANEL (MOBILE FIRST)
------------------------------------------------------------ */
.control-row {
    width:95%;
    margin:auto;
    display:flex;
    flex-direction:column;
    gap:14px;
}

.control-col {
    background:rgba(255,255,255,0.07);
    padding:12px;
    border-radius:12px;
    backdrop-filter:blur(14px);
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:center;
    box-shadow:0 0 18px rgba(0,120,255,0.35);
}

input, select, button {
    height:40px;
    padding:5px 12px;
    border-radius:6px;
    border:none;
    font-size:15px;
}

input, select {
    background:white;
    color:#000;
}

button {
    background:#007bff;
    color:white;
}

button:hover {
    background:#4ea3ff;
}

.danger { background:#ff3d3d !important; }
.danger:hover { background:#ff7878 !important; }

/* -----------------------------------------------------------
   VIEW GROUP SELECTOR
------------------------------------------------------------ */
.viewBar {
    width:95%;
    margin:22px auto;
    padding:14px;
    background:rgba(255,255,255,0.07);
    border-radius:12px;
    text-align:center;
    backdrop-filter:blur(14px);
    box-shadow:0 0 18px rgba(0,120,255,0.35);
}

/* -----------------------------------------------------------
   TABLE ‚Äî SHOWN ONLY ON DESKTOP/TABLET
------------------------------------------------------------ */
table {
    width:95%;
    margin:25px auto;
    border-collapse:collapse;
    background:rgba(255,255,255,0.08);
    border-radius:14px;
    display:none; /* HIDDEN ON MOBILE */
}

th, td {
    border-bottom:1px solid rgba(255,255,255,0.18);
    padding:10px;
    text-align:center;
}

th {
    background:rgba(0,80,140,0.8);
    font-size:16px;
}

/* -----------------------------------------------------------
   MOBILE CARD VIEW
------------------------------------------------------------ */
#mobileCards {
    width:95%;
    margin:20px auto;
    display:flex;
    flex-direction:column;
    gap:14px;
}

.card {
    background:rgba(255,255,255,0.08);
    padding:14px;
    border-radius:14px;
    box-shadow:0 0 14px rgba(0,120,255,0.35);
    backdrop-filter:blur(14px);
}

.card h3 {
    margin:0 0 8px 0;
    font-size:18px;
    text-shadow:0 0 6px rgba(0,150,255,0.8);
}

.card-row {
    display:flex;
    justify-content:space-between;
    margin:6px 0;
}

/* -----------------------------------------------------------
   NAME EDIT POPUP
------------------------------------------------------------ */
#nameEditPopup {
    position:fixed;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    width:90%; max-width:380px;
    background:#002647;
    padding:18px;
    border-radius:12px;
    box-shadow:0 0 18px rgba(0,150,255,1);
    display:none;
    z-index:300;
}

#nameEditPopup input {
    width:100%;
    margin:12px 0;
}

/* -----------------------------------------------------------
   ERROR POPUP
------------------------------------------------------------ */
#excelErrorPopup {
    position:fixed;
    left:50%;
    top:-300px;
    transform:translateX(-50%);
    width:90%;
    max-width:420px;
    background:#001e36;
    padding:20px;
    border-radius:12px;
    color:white;
    text-align:center;
    z-index:300;
    box-shadow:0 0 18px rgba(0,150,255,1);
    animation-duration:0.7s;
    animation-fill-mode:forwards;
}

@keyframes slideDown {
    from { top:-300px; opacity:0; }
    to   { top:110px; opacity:1; }
}

/* -----------------------------------------------------------
   RESPONSIVE BREAKPOINTS
------------------------------------------------------------ */

/* TABLE MODE FOR SCREENS ABOVE 768px */
@media(min-width:768px){
    table { display:table; }
    #mobileCards { display:none; }

    .control-row { flex-direction:row; }
}

</style>
</head>

<body>

<div class="bg"></div>
<div class="bgOverlay"></div>

<div class="headerBar">
    <h1>Ice Skating Short Track Ranking Dashboard</h1>
</div>


<!-- -----------------------------------------------------------
     CONTROL PANEL
------------------------------------------------------------ -->
<div class="control-row">

    <!-- Column 1 -->
    <div class="control-col">
        <input type="file" id="excelFile" accept=".xls,.xlsx">
        <button onclick="uploadExcel()">Upload Excel</button>
    </div>

    <!-- Column 2 -->
    <div class="control-col">
        <input id="skaterName" placeholder="Manually enter the name">
        <button onclick="addManual()">Add</button>

        <select id="addGroupSelect">
            <option>Alpha</option><option>Bravo</option><option>Charlie</option>
            <option>Delta</option><option>Echo</option><option>Foxtrot</option>
            <option>Golf</option><option>Hotel</option><option>India</option>
        </select>
    </div>

    <!-- Column 3 -->
    <div class="control-col">
        <button class="danger" onclick="resetGroup()">Reset Group</button>
        <button class="danger" onclick="resetAll()">Reset All</button>
        <button onclick="openHelp()">Help</button>
    </div>

</div>

<!-- -----------------------------------------------------------
     GROUP SELECT
------------------------------------------------------------ -->
<div class="viewBar">
    <label style="font-size:17px;font-weight:bold;">Select Group to View Scoreboard</label><br>
    <select id="viewGroupSelect" onchange="switchGroup()" style="width:220px;margin-top:6px;">
        <option>Alpha</option><option>Bravo</option><option>Charlie</option>
        <option>Delta</option><option>Echo</option><option>Foxtrot</option>
        <option>Golf</option><option>Hotel</option><option>India</option>
    </select>
</div>

<!-- -----------------------------------------------------------
     DESKTOP TABLE
------------------------------------------------------------ -->
<table id="scoreTable">
    <thead>
        <tr>
            <th>Name</th>
            <th>400</th><th>500</th><th>800</th><th>1000</th><th>1500</th>
            <th>Total</th><th>Rank</th><th>Undo</th><th>Delete</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- -----------------------------------------------------------
     MOBILE CARD VIEW
------------------------------------------------------------ -->
<div id="mobileCards"></div>

<!-- -----------------------------------------------------------
     NAME EDIT POPUP
------------------------------------------------------------ -->
<div id="nameEditPopup">
    <h3>Edit Name</h3>
    <input id="nameEditInput">
    <button onclick="saveNameEdit()">Save</button>
    <button class="danger" onclick="closeNamePopup()">Cancel</button>
</div>

<!-- -----------------------------------------------------------
     EXCEL ERROR POPUP
------------------------------------------------------------ -->
<div id="excelErrorPopup">
    <p style="font-size:16px;">
        <b><i>Sorry ‚Äî Excel file didn‚Äôt upload properly.<br><br>
        Please try again or enter names manually.</i></b>
    </p>
    <button onclick="closeExcelErrorPopup()" style="margin-top:10px;">Close</button>
</div>

<!-- -----------------------------------------------------------
     HELP POPUP
------------------------------------------------------------ -->
<div id="helpPopup" style="display:none;">
    <div style="padding:20px; background:#002a4c; border-radius:12px;">
        <h2>Instructions</h2>

        <p>‚Ä¢ Upload Excel sheet (sheet name must be ‚ÄúDivisions‚Äù).</p>
        <p>‚Ä¢ Or add names manually + select group.</p>
        <p>‚Ä¢ Tap a name to edit it anytime.</p>
        <p>‚Ä¢ Enter race positions ‚Äî points calculate instantly.</p>
        <p>‚Ä¢ Rankings & medals update automatically.</p>
        <p>‚Ä¢ Undo reverses only the last change.</p>
        <p>‚Ä¢ Delete removes the skater completely.</p>
        <p>‚Ä¢ Reset Group clears only the selected group.</p>
        <p>‚Ä¢ Reset All wipes everything (use carefully).</p>
        <p>‚Ä¢ All progress auto-saves (LocalStorage).</p>

        <button onclick="closeHelp()" style="margin-top:14px;">Close</button>
    </div>
</div>

<script>

/* -----------------------------------------------------------
   SAME JS LOGIC FROM YOUR PREVIOUS VERSION + NEW UPDATES
   ‚Äî Auto-sort
   ‚Äî Ties
   ‚Äî Medals
   ‚Äî Editable Names
   ‚Äî Mobile Card View
------------------------------------------------------------ */

let groups={};
["Alpha","Bravo","Charlie","Delta","Echo","Foxtrot","Golf","Hotel","India"]
.forEach(g=>groups[g]={skaters:[],history:{}});

if(localStorage.getItem("groupsData"))
    groups=JSON.parse(localStorage.getItem("groupsData"));

let currentGroup="Alpha";
const distances=["400","500","800","1000","1500"];

const points={1:1000,2:816,3:666,4:543,5:443,6:362,7:295,8:241,9:196,10:160,
              11:130,12:106,13:86,14:70,15:57};

const validGroups=["ALPHA","BRAVO","CHARLIE","DELTA","ECHO","FOXTROT","GOLF","HOTEL","INDIA"];

function saveData(){localStorage.setItem("groupsData",JSON.stringify(groups));}

function switchGroup(){ currentGroup=document.getElementById("viewGroupSelect").value; loadGroup(); }

function resetGroup(){
    if(!confirm("Reset this group?")) return;
    groups[currentGroup]={skaters:[],history:{}};
    saveData(); loadGroup();
}

function resetAll(){
    if(!confirm("Reset ALL groups?")) return;
    ["Alpha","Bravo","Charlie","Delta","Echo","Foxtrot","Golf","Hotel","India"]
    .forEach(g=>groups[g]={skaters:[],history:{}});
    saveData(); loadGroup();
}

function cleanName(n){
    return n.replace(/[0-9]/g,"").replace(/\s+/g," ").trim();
}

function addManual(){
    let name=cleanName(document.getElementById("skaterName").value.trim());
    if(!name) return;
    let g=document.getElementById("addGroupSelect").value;
    addSkater(name,g);
    document.getElementById("skaterName").value="";
}

function addSkater(name,group){
    let G=groups[group];
    if(!G.skaters.includes(name)){
        G.skaters.push(name);
        G.history[name]={"400":[],"500":[],"800":[],"1000":[],"1500":[]};
    }
    saveData();
    if(group===currentGroup) loadGroup();
}

function uploadExcel(){
    let file=document.getElementById("excelFile").files[0];
    if(!file){ alert("Select Excel file"); return; }

    let reader=new FileReader();
    reader.onload=e=>{
        let data=new Uint8Array(e.target.result);
        let book=XLSX.read(data,{type:'array'});
        let sheet=book.Sheets["Divisions"];
        if(!sheet) return showExcelErrorPopup();

        let rows=XLSX.utils.sheet_to_json(sheet,{header:1});
        let detected=null, added=0;

        for(let row of rows){
            if(!row) continue;

            let groupCell=row[7];
            if(typeof groupCell==="string"){
                let G=groupCell.trim().toUpperCase();
                if(validGroups.includes(G)){
                    detected=G.charAt(0)+G.slice(1).toLowerCase();
                    continue;
                }
            }

            let c1=(row[1]||"").toString().trim();
            let c2=(row[2]||"").toString().trim();
            let c3=(row[3]||"").toString().trim();
            let c4=(row[4]||"").toString().trim();

            let combined=(c1+" "+c2+" "+c3+" "+c4).toUpperCase();
            if(combined.includes("FIRST")||combined.includes("LAST")||combined.includes("NAME")) continue;

            let name=null;
            if(isName(c1)&&isName(c2)) name=c1+" "+c2;
            else if(isName(c2)&&isName(c3)) name=c2+" "+c3;
            else if(isName(c3)&&isName(c4)) name=c3+" "+c4;

            if(name && detected){
                name=cleanName(name);
                addSkater(name,detected);
                added++;
            }
        }

        if(added===0) showExcelErrorPopup();
        else{ saveData(); loadGroup(); }
    };

    reader.readAsArrayBuffer(file);
}

function isName(x){
    if(!x||typeof x!=="string") return false;
    x=x.trim();
    return x.length>1 && /^[A-Za-z√Ä-√ø ' -]+$/.test(x);
}

/* -----------------------------------------------------------
   LOAD GROUP ‚Äî BUILDS BOTH DESKTOP TABLE + MOBILE CARDS
------------------------------------------------------------ */
function loadGroup(){
    loadTable();
    loadMobileCards();
}

function loadTable(){
    let tbody=document.querySelector("#scoreTable tbody");
    tbody.innerHTML="";

    groups[currentGroup].skaters.forEach(name=>{
        let row=document.createElement("tr");
        row.dataset.name=name;

        row.innerHTML=`
            <td class="name" onclick="editName('${name}')">${name}</td>
            <td></td><td></td><td></td><td></td><td></td>
            <td class="total">0</td>
            <td class="rank">-</td>
            <td><button onclick="undo('${name}')">Undo</button></td>
            <td><button class="danger" onclick="del('${name}')">Delete</button></td>
        `;

        distances.forEach((dist,i)=>{
            let cell=row.children[i+1];
            cell.append(selectDropdown(name,dist));
        });

        tbody.appendChild(row);
    });

    rebuildDropdowns();
    updateScores();
}

function loadMobileCards(){
    let box=document.getElementById("mobileCards");
    box.innerHTML="";

    groups[currentGroup].skaters.forEach(name=>{
        let card=document.createElement("div");
        card.className="card";
        card.dataset.name=name;

        let scoreHTML="";
        distances.forEach(dist=>{
            scoreHTML+=`
                <div class="card-row">
                    <span>${dist}m</span>
                    <span>${createMobileDropdown(name,dist)}</span>
                </div>
            `;
        });

        card.innerHTML=`
            <h3 onclick="editName('${name}')">${name}</h3>
            ${scoreHTML}
            <div class="card-row"><b>Total</b><span class="total">0</span></div>
            <div class="card-row"><b>Rank</b><span class="rank">-</span></div>

            <button onclick="undo('${name}')">Undo</button>
            <button class="danger" onclick="del('${name}')">Delete</button>
        `;

        box.appendChild(card);
    });

    updateScores();
}

function selectDropdown(name,dist){
    let dd=document.createElement("select");
    dd.className="position";
    dd.innerHTML=`<option value="">-</option>`;
    let count=groups[currentGroup].skaters.length;
    for(let i=1;i<=count;i++) dd.innerHTML+=`<option>${i}</option>`;
    dd.onchange=()=>storeHistory(name,dist,dd);
    return dd;
}

function createMobileDropdown(name,dist){
    let count=groups[currentGroup].skaters.length;
    let html=`<select class="mPos" data-name="${name}" data-dist="${dist}" onchange="mobileScoreChange(this)">`;
    html+=`<option value="">-</option>`;
    for(let i=1;i<=count;i++) html+=`<option>${i}</option>`;
    html+=`</select>`;
    return html;
}

function mobileScoreChange(el){
    let name=el.dataset.name;
    let dist=el.dataset.dist;
    let val=el.value;

    let hist=groups[currentGroup].history[name][dist];
    hist.push(el.getAttribute("data-last")||"");
    el.setAttribute("data-last",val);

    updateScores();
    saveData();
}

function storeHistory(name,dist,dd){
    groups[currentGroup].history[name][dist].push(dd.getAttribute("data-last")||"");
    dd.setAttribute("data-last",dd.value);
    updateScores();
    saveData();
}

function rebuildDropdowns(){
    let count=groups[currentGroup].skaters.length;
    document.querySelectorAll("select.position, select.mPos").forEach(dd=>{
        let old=dd.value;
        dd.innerHTML=`<option value="">-</option>`;
        for(let i=1;i<=count;i++) dd.innerHTML+=`<option>${i}</option>`;
        dd.value=old;
    });
}

/* -----------------------------------------------------------
   SCORE UPDATE + SORT + MEDALS + TIES
------------------------------------------------------------ */
function updateScores(){
    let allRows=document.querySelectorAll("#scoreTable tbody tr, #mobileCards .card");
    let anyScore=false;

    allRows.forEach(row=>{
        let total=0;

        if(row.querySelectorAll("select.position").length){
            row.querySelectorAll("select.position").forEach(dd=>{
                let pos=Number(dd.value);
                if(points[pos]) total+=points[pos];
            });
        } else {
            row.querySelectorAll("select.mPos").forEach(dd=>{
                let pos=Number(dd.value);
                if(points[pos]) total+=points[pos];
            });
        }

        row.querySelector(".total").textContent=total;
        if(total>0) anyScore=true;
    });

    if(!anyScore){
        resetRanks();
        return;
    }

    applyRanking();
}

function resetRanks(){
    document.querySelectorAll(".rank").forEach(r=>r.textContent="-");
    document.querySelectorAll(".name").forEach(n=>{
        n.textContent=n.textContent.replace(/ü•á|ü•à|ü•â/g,"");
    });
}

function applyRanking() {
    let rows = [...document.querySelectorAll("#scoreTable tbody tr")];

    // Separate scored vs non-scored skaters
    let scored = rows.filter(r => Number(r.querySelector(".total").textContent) > 0);
    let zeroScore = rows.filter(r => Number(r.querySelector(".total").textContent) === 0);

    // Sort only scored skaters
    scored.sort((a, b) =>
        Number(b.querySelector(".total").textContent) -
        Number(a.querySelector(".total").textContent)
    );

    // Assign ranks + medals only to scored skaters
    let lastScore = null;
    let lastRank = 0;

    scored.forEach((row, index) => {
        let total = Number(row.querySelector(".total").textContent);


/* -----------------------------------------------------------
   UNDO / DELETE
------------------------------------------------------------ */
function undo(name){
    let g=groups[currentGroup];
    let hist=g.history[name];

    distances.forEach((dist,i)=>{
        let stack=hist[dist];
        if(stack.length>0){
            let prev=stack.pop();

            let ddDesktop=document.querySelector(`tr[data-name="${name}"] select.position:nth-child(${i+1})`);
            let ddMobile=document.querySelector(`.card[data-name="${name}"] select.mPos[data-dist="${dist}"]`);

            if(ddDesktop){ ddDesktop.value=prev || ""; ddDesktop.setAttribute("data-last",prev||""); }
            if(ddMobile){ ddMobile.value=prev || ""; ddMobile.setAttribute("data-last",prev||""); }
        }
    });

    updateScores();
    saveData();
}

function del(name){
    let g=groups[currentGroup];
    g.skaters=g.skaters.filter(n=>n!==name);
    delete g.history[name];
    saveData();
    loadGroup();
}

/* -----------------------------------------------------------
   NAME EDIT POPUP
------------------------------------------------------------ */
let editTarget=null;

function editName(name){
    editTarget=name;
    document.getElementById("nameEditInput").value=name;
    document.getElementById("nameEditPopup").style.display="block";
}

function closeNamePopup(){
    document.getElementById("nameEditPopup").style.display="none";
}

function saveNameEdit(){
    let newName=cleanName(document.getElementById("nameEditInput").value.trim());
    if(!newName) return;

    let g=groups[currentGroup];

    let idx=g.skaters.indexOf(editTarget);
    if(idx>-1) g.skaters[idx]=newName;

    g.history[newName]=g.history[editTarget];
    delete g.history[editTarget];

    saveData();
    closeNamePopup();
    loadGroup();
}

/* -----------------------------------------------------------
   ERROR POPUP
------------------------------------------------------------ */
function showExcelErrorPopup(){
    let p=document.getElementById("excelErrorPopup");
    p.style.display="block";
    p.style.animationName="slideDown";
}

function closeExcelErrorPopup(){
    document.getElementById("excelErrorPopup").style.display="none";
}

/* HELP */
function openHelp(){ document.getElementById("helpPopup").style.display="block"; }
function closeHelp(){ document.getElementById("helpPopup").style.display="none"; }

/* INIT */
loadGroup();

</script>
</body>
</html>
