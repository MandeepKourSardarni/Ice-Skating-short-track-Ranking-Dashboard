<!DOCTYPE html>
<html>
<head>
<title>Ice Skating Short Track Ranking Dashboard</title>

<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
/* =========================
   BASE
========================= */
:root{
  --panel: rgba(18,18,20,0.55);
  --panel2: rgba(18,18,20,0.40);
  --stroke: rgba(255,255,255,0.12);
  --stroke2: rgba(255,255,255,0.18);

  --text: rgba(255,255,255,0.92);
  --muted: rgba(255,255,255,0.72);

  --primary: #2F7CF6;
  --primaryHover: #2568D8;

  --danger: #E24B4B;
  --dangerHover: #C63F3F;

  --radius: 14px;
  --radiusSm: 10px;
  --shadow: 0 10px 26px rgba(0,0,0,0.38);
}

html, body{
  margin:0;
  padding:0;
  max-width:100%;
  overflow-x:hidden;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color: var(--text);
}

body{
  background: transparent !important;
}

/* Background */
.bg{
  background-image:url("https://raw.githubusercontent.com/MandeepKourSardarni/Ice-Skating-short-track-Ranking-Dashboard/main/image.jpg?raw=1");
  background-size:cover;
  background-position:center;
  background-attachment:fixed;
  position:fixed;
  inset:0;
  z-index:-3;
}
.bgOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45);
  z-index:-2;
}

/* App container shell */
.appShell{
  width:min(980px, 94vw);
  margin: 16px auto 26px;
  padding: 14px;
  border-radius: 18px;
  background: rgba(0,0,0,0.18);
  border: 1px solid rgba(255,255,255,0.10);
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow);
}

/* Header */
.headerBar{
  padding: 14px 14px;
  border-radius: 16px;
  background: var(--panel2);
  border: 1px solid var(--stroke);
  backdrop-filter: blur(14px);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
}

h1{
  margin:0;
  font-size: 22px;
  font-weight: 700;
  letter-spacing: 0.2px;
  line-height: 1.2;
}

.headerRight{
  display:flex;
  align-items:center;
  gap:10px;
}

/* Theme toggle (compact + professional) */
.theme-switch{
  --h: 26px;
  --w: 52px;
  width:var(--w);
  height:var(--h);
  border-radius:var(--h);
  background:rgba(255,255,255,0.15);
  border:1px solid var(--stroke2);
  position:relative;
  cursor:pointer;
  transition:0.2s ease;
  padding:0;
}
.theme-switch:hover{ background:rgba(255,255,255,0.20); }

.theme-switch .slider{
  width:calc(var(--h) - 6px);
  height:calc(var(--h) - 6px);
  background:rgba(255,255,255,0.92);
  border-radius:50%;
  position:absolute;
  top:3px;
  left:3px;
  transition:0.2s ease;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:13px;
}
.theme-switch.dark .slider{ transform:translateX(26px); }
.sun{ display:none; }
.moon{ display:block; }
.dark .sun{ display:block; }
.dark .moon{ display:none; }

/* Gift button */
.giftBtn{
  height: 34px;
  width: 40px;
  border-radius: 12px;
  border:1px solid var(--stroke2);
  background: rgba(255,255,255,0.14);
  color: var(--text);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  line-height: 1;
  transition:0.2s ease;
}
.giftBtn:hover{ background:rgba(255,255,255,0.20); }

/* Light/Dark theme (kept, but cleaner) */
.light-mode{
  color: rgba(0,0,0,0.86);
}
.light-mode .appShell{
  background: rgba(255,255,255,0.20);
  border-color: rgba(0,0,0,0.08);
}
.light-mode .headerBar,
.light-mode .card,
.light-mode .viewBar,
.light-mode table{
  background: rgba(255,255,255,0.55) !important;
  color: rgba(0,0,0,0.86) !important;
  border-color: rgba(0,0,0,0.10) !important;
}
.light-mode .cardTitle,
.light-mode .mutedSmall{ color: rgba(0,0,0,0.60) !important; }
.light-mode th{ background: rgba(15,55,120,0.85) !important; color:white !important; }

.dark-mode{
  color: var(--text);
}

/* =========================
   DASHBOARD CARDS (TOP CONTROLS)
========================= */
.control-row{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 12px;
  margin-top: 12px;
}

.card{
  background: var(--panel);
  border: 1px solid var(--stroke);
  border-radius: var(--radius);
  backdrop-filter: blur(14px);
  padding: 12px;
  box-shadow: 0 8px 18px rgba(0,0,0,0.18);
}

.cardTitle{
  font-size: 12px;
  letter-spacing: 0.6px;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 10px;
}

/* Inputs + buttons (professional) */
input, select, button{
  height: 40px;
  border-radius: var(--radiusSm);
  border: 1px solid rgba(255,255,255,0.14);
  font-size: 14px;
  outline:none;
}

input, select{
  width:100%;
  padding: 8px 10px;
  background: rgba(255,255,255,0.90);
  color: #111;
}

button{
  width:100%;
  padding: 8px 10px;
  cursor:pointer;
  border: 1px solid rgba(255,255,255,0.10);
  transition:0.18s ease;
}

/* Button styles */
.btnPrimary{
  background: var(--primary);
  color:white;
}
.btnPrimary:hover{ background: var(--primaryHover); }

.btnSecondary{
  background: rgba(255,255,255,0.12);
  color: var(--text);
  border: 1px solid var(--stroke2);
}
.btnSecondary:hover{ background: rgba(255,255,255,0.18); }

.btnDangerOutline{
  background: rgba(226,75,75,0.14);
  color: #ffd9d9;
  border: 1px solid rgba(226,75,75,0.35);
}
.btnDangerOutline:hover{
  background: rgba(226,75,75,0.20);
  border-color: rgba(226,75,75,0.55);
}

/* Inline rows inside cards */
.row{
  display:flex;
  gap:10px;
  align-items:center;
  margin-top:10px;
}
.row > *{ flex:1; }

.mutedSmall{
  font-size: 12px;
  color: var(--muted);
  margin-top: 8px;
}

/* View bar */
.viewBar{
  margin-top: 12px;
  padding: 12px;
  border-radius: var(--radius);
  background: var(--panel);
  border: 1px solid var(--stroke);
  backdrop-filter: blur(14px);
}

.viewBar label{
  font-size: 13px;
  color: var(--muted);
}

/* Table */
table{
  width:100%;
  margin-top: 12px;
  border-collapse:separate;
  border-spacing:0;
  border-radius: var(--radius);
  overflow:hidden;
  background: var(--panel);
  border: 1px solid var(--stroke);
  backdrop-filter: blur(12px);
}
th, td{
  text-align:center;
  padding: 12px 10px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
th{
  background: rgba(8,45,95,0.85);
  font-size: 13px;
  letter-spacing: 0.2px;
}
td.name{ text-align:left; font-weight: 600; }

select.position{
  width: 64px;
  height: 38px;
}

/* =========================
   POPUPS (keep your ids)
========================= */
#excelErrorPopup{
  position:fixed;
  left:50%;
  top: 14vh;
  transform:translateX(-50%);
  width:min(420px, 90vw);
  background:rgba(0,0,0,0.86);
  padding:18px;
  border-radius:16px;
  color:white;
  text-align:center;
  z-index:99999;
  display:none;
  border: 1px solid rgba(255,255,255,0.12);
  box-shadow: var(--shadow);
}
#excelErrorPopup button{
  margin-top: 10px;
  background: var(--primary);
  border: none;
  border-radius: 12px;
  height: 40px;
}
#excelErrorPopup button:hover{ background: var(--primaryHover); }

.glassConfirm{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  backdrop-filter:blur(10px);
  z-index:500;
  align-items:center;
  justify-content:center;
}
.confirmBox{
  width:min(380px, 90vw);
  padding:18px;
  background: rgba(18,18,20,0.72);
  border: 1px solid rgba(255,255,255,0.14);
  border-radius: 18px;
  color:white;
  text-align:center;
  box-shadow: var(--shadow);
}
.confirmButtons{
  margin-top:14px;
  display:flex;
  gap:10px;
}
.confirmCancel, .confirmYes{
  height: 40px;
  border-radius: 12px;
  width:100%;
}
.confirmCancel{ background: rgba(255,255,255,0.14); color:white; border:1px solid rgba(255,255,255,0.18); }
.confirmYes{ background: var(--primary); color:white; border:1px solid rgba(255,255,255,0.10); }
.confirmYes:hover{ background: var(--primaryHover); }

#editNamePopup,
#helpPopup{
  position:fixed;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  width:min(420px, 92vw);
  background: rgba(18,18,20,0.85);
  border: 1px solid rgba(255,255,255,0.14);
  padding:18px;
  border-radius: 18px;
  color:white;
  text-align:center;
  display:none;
  z-index:300;
  box-shadow: var(--shadow);
}

#distancePopup,
#manageDistancesPopup,
#actionsPopup{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.58);
  backdrop-filter:blur(10px);
  color:white;
  z-index:5000;
  align-items:center;
  justify-content:center;
}

.distanceBox{
  width:min(420px, 92vw);
  padding:18px;
  background: rgba(18,18,20,0.78);
  border: 1px solid rgba(255,255,255,0.14);
  border-radius: 18px;
  text-align:center;
  box-shadow: var(--shadow);
}

.distanceRow{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  margin:8px 0;
}
.distanceRow input{ width: 90px; text-align:center; }

/* PayPal popup */
#paypalPopup{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.60);
  backdrop-filter:blur(10px);
  z-index:6000;
  align-items:center;
  justify-content:center;
}
.paypalBox{
  width:min(420px, 92vw);
  padding:18px;
  background: rgba(18,18,20,0.80);
  border: 1px solid rgba(255,255,255,0.14);
  border-radius: 18px;
  text-align:center;
  color:white;
  box-shadow: var(--shadow);
}
.paypalLinks{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  margin-top:12px;
}
.paypalLinks a{ text-decoration:none; }
.paypalLinks button{ height: 42px; }

/* =========================
   MOBILE
========================= */
@media (max-width: 940px){
  .control-row{ grid-template-columns: 1fr; }
  .bg{ background-attachment: scroll; }
  h1{ font-size: 18px; }
  .paypalLinks{ grid-template-columns: 1fr 1fr; }
}

@media (max-width: 420px){
  .appShell{ padding: 12px; }
  .paypalLinks{ grid-template-columns: 1fr; }
  th, td{ padding: 10px 8px; }
}

/* Make table scrollable on small screens */
@media (max-width: 860px){
  table{
    display:block;
    overflow-x:auto;
    white-space:nowrap;
    -webkit-overflow-scrolling:touch;
  }
}

/* IMPORTANT: your old inline width (220px) should not break mobile */
#viewGroupSelect{ width:100% !important; }
</style>
</head>

<body>

<div class="bg"></div>
<div class="bgOverlay"></div>

<div class="appShell">

  <div class="headerBar">
    <h1>Ice Skating Short Track Ranking Dashboard</h1>

    <div class="headerRight">
      <button id="themeToggle" class="theme-switch" aria-label="Toggle theme">
        <div class="slider">
          <span class="moon">üåô</span>
          <span class="sun">‚òÄÔ∏è</span>
        </div>
      </button>

      <button class="giftBtn" onclick="openPaypalPopup()" title="Support via PayPal">üéÅ</button>
    </div>
  </div>

  <!-- CONTROL ROW -->
  <div class="control-row">

    <!-- Upload card -->
    <div class="card">
      <div class="cardTitle">Upload</div>
      <input type="file" id="excelFile" accept=".xls,.xlsx">
      <div class="row">
        <button class="btnPrimary" onclick="uploadExcel()">Upload Excel</button>
      </div>
      <div class="mutedSmall">Upload official Excel (clubs/divisions)</div>
    </div>

    <!-- Add card -->
    <div class="card">
      <div class="cardTitle">Add skater</div>
      <input id="skaterName" placeholder="Enter name">
      <div class="row">
        <button class="btnPrimary" onclick="addManual()">Add</button>
        <select id="addGroupSelect">
          <option>Alpha</option><option>Bravo</option><option>Charlie</option>
          <option>Delta</option><option>Echo</option><option>Foxtrot</option>
          <option>Golf</option><option>Hotel</option><option>India</option>
        </select>
      </div>
      <div class="mutedSmall">Type a name and choose group</div>
    </div>

    <!-- Actions card -->
    <div class="card">
      <div class="cardTitle">Manage</div>
      <div class="row">
        <button class="btnDangerOutline" onclick="resetGroup()">Reset Group</button>
        <button class="btnDangerOutline" onclick="resetAll()">Reset All</button>
      </div>
      <div class="row">
        <button class="btnSecondary" onclick="openHelp()">Help</button>
        <button id="addDistanceBtn" class="btnSecondary" onclick="openActionsPopup()">Actions</button>
      </div>
      <div class="mutedSmall">Edit distances, help, reset data</div>
    </div>

  </div>

  <!-- VIEW BAR -->
  <div class="viewBar">
    <div id="excelHeading" style="display:none; font-size:14px; margin-bottom:10px; white-space:normal; color:rgba(255,255,255,0.85);"></div>
    <label>Select Group</label>
    <div style="margin-top:8px;">
      <select id="viewGroupSelect" onchange="switchGroup()">
        <option>Alpha</option><option>Bravo</option><option>Charlie</option>
        <option>Delta</option><option>Echo</option><option>Foxtrot</option>
        <option>Golf</option><option>Hotel</option><option>India</option>
      </select>
    </div>
  </div>

  <!-- SCOREBOARD TABLE -->
  <table id="scoreTable">
    <thead>
      <tr id="headerRow"></tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<!-- ERROR POPUP -->
<div id="excelErrorPopup">
  <div class="excelErrorBox">
    <h3 style="margin:0 0 8px 0;">‚ö†Ô∏è Upload issue</h3>
    <p style="margin:0; opacity:0.9;">Excel format not detected. Try again or add names manually.</p>
    <button onclick="closeExcelErrorPopup()">OK</button>
  </div>
</div>

<!-- EDIT NAME POPUP -->
<div id="editNamePopup">
  <h2 style="margin:0 0 12px 0;">Edit Name</h2>
  <input id="editNameInput">
  <br><br>
  <button class="btnPrimary" onclick="saveEditedName()">Save</button>
  <button class="btnDangerOutline" onclick="closeEditName()">Cancel</button>
</div>

<!-- HELP POPUP -->
<div id="helpPopup">
  <h2 style="margin:0 0 10px 0;">Instructions</h2>
  <p style="margin:8px 0; opacity:0.9;">üìÑ Upload Excel or add names manually</p>
  <p style="margin:8px 0; opacity:0.9;">üèÖ Choose race positions ‚Üí points update automatically</p>
  <p style="margin:8px 0; opacity:0.9;">‚öôÔ∏è Actions: add/edit/delete distances (points unchanged)</p>
  <p style="margin:8px 0; opacity:0.9;">üìå Data is stored on your device</p>
  <button class="btnSecondary" onclick="closeHelp()">Close</button>
</div>

<!-- Confirm Popup -->
<div id="confirmPopup" class="glassConfirm">
  <div class="confirmBox">
    <p id="confirmMessage" style="margin:0;">Are you sure?</p>
    <div class="confirmButtons">
      <button class="confirmCancel" onclick="closeConfirm(false)">Cancel</button>
      <button class="confirmYes" onclick="closeConfirm(true)">Yes</button>
    </div>
  </div>
</div>

<!-- Actions Popup -->
<div id="actionsPopup">
  <div class="distanceBox">
    <h2 style="margin:0 0 12px 0;">Actions</h2>
    <button class="btnPrimary" onclick="openDistanceFromActions()">‚ûï Add New Distance</button>
    <br><br>
    <button class="btnSecondary" onclick="openManageFromActions()">‚úèÔ∏è Edit / Delete Distances</button>
    <br><br>
    <button class="btnDangerOutline" onclick="closeActionsPopup()">Close</button>
  </div>
</div>

<!-- ADD DISTANCE POPUP -->
<div id="distancePopup">
  <div class="distanceBox">
    <h2 style="margin:0 0 10px 0;">Add New Distance</h2>
    <p style="margin:0; opacity:0.85;">Enter numeric distance (e.g., 300)</p>
    <input id="newDistanceInput" placeholder="300" oninput="this.value=this.value.replace(/[^0-9]/g,'');" style="margin-top:10px;">
    <br><br>
    <button class="btnPrimary" onclick="saveNewDistance()">Add</button>
    <button class="btnDangerOutline" onclick="closeDistancePopup()">Cancel</button>
  </div>
</div>

<!-- MANAGE DISTANCES POPUP -->
<div id="manageDistancesPopup">
  <div class="distanceBox">
    <h2 style="margin:0 0 10px 0;">Edit / Delete Distances</h2>
    <p style="margin:0; opacity:0.85;">Edit values or delete rows</p>
    <div id="distancesList" style="margin-top:12px;"></div>
    <br>
    <button class="btnPrimary" onclick="saveManagedDistances()">Save</button>
    <button class="btnDangerOutline" onclick="closeManageDistances()">Close</button>
  </div>
</div>

<!-- PAYPAL POPUP -->
<div id="paypalPopup">
  <div class="paypalBox">
    <h2 style="margin:0 0 8px 0;">Support this dashboard</h2>
    <p style="margin:0; opacity:0.9;">Optional support via PayPal</p>

    <div class="paypalLinks">
      <a href="https://www.paypal.me/MandeepSardarni/2" target="_blank"><button class="btnPrimary">$2</button></a>
      <a href="https://www.paypal.me/MandeepSardarni/5" target="_blank"><button class="btnPrimary">$5</button></a>
      <a href="https://www.paypal.me/MandeepSardarni/10" target="_blank"><button class="btnPrimary">$10</button></a>
      <a href="https://www.paypal.me/MandeepSardarni" target="_blank"><button class="btnSecondary">Custom</button></a>
    </div>

    <br>
    <button class="btnDangerOutline" onclick="closePaypalPopup()">Close</button>
  </div>
</div>

<script>
/* ==================================================
      THEME TOGGLE
=================================================== */
const toggleBtn = document.getElementById("themeToggle");
let savedTheme = localStorage.getItem("theme") || "dark";

applyTheme(savedTheme);

toggleBtn.onclick = () => {
  let newTheme = document.body.classList.contains("dark-mode") ? "light" : "dark";
  applyTheme(newTheme);
};

function applyTheme(mode) {
  if (mode === "light") {
    document.body.classList.remove("dark-mode");
    document.body.classList.add("light-mode");
    toggleBtn.classList.remove("dark");
  } else {
    document.body.classList.remove("light-mode");
    document.body.classList.add("dark-mode");
    toggleBtn.classList.add("dark");
  }
  localStorage.setItem("theme", mode);
}

/* ==================================================
      ERROR POPUP
=================================================== */
function showExcelErrorPopup() { document.getElementById("excelErrorPopup").style.display = "block"; }
function closeExcelErrorPopup() { document.getElementById("excelErrorPopup").style.display = "none"; }

/* ==================================================
      CONFIRM POPUP
=================================================== */
let confirmCallback = null;

function showConfirm(message, callback) {
  document.getElementById("confirmMessage").textContent = message;
  document.getElementById("confirmPopup").style.display = "flex";
  confirmCallback = callback;
}

function closeConfirm(result) {
  document.getElementById("confirmPopup").style.display = "none";
  if (confirmCallback) confirmCallback(result);
}

/* ==================================================
      EXCEL HELPERS
=================================================== */
const validGroups = ["ALPHA","BRAVO","CHARLIE","DELTA","ECHO","FOXTROT","GOLF","HOTEL","INDIA"];

function isName(x){
  if(!x || typeof x!=="string")return false;
  x=x.trim();
  if(x.length<2)return false;
  if(/[^A-Za-z√Ä-√ø '-]/.test(x))return false;
  return true;
}

/* ==================================================
      DATA STRUCTURE
=================================================== */
let groups = {};
["Alpha","Bravo","Charlie","Delta","Echo","Foxtrot","Golf","Hotel","India"]
.forEach(g=>groups[g]={skaters:[],history:{}});

if(localStorage.getItem("groupsData")){
  try { groups = JSON.parse(localStorage.getItem("groupsData")); }
  catch(e){
    console.error("Bad local groupsData, resetting", e);
    ["Alpha","Bravo","Charlie","Delta","Echo","Foxtrot","Golf","Hotel","India"]
    .forEach(g=>groups[g]={skaters:[],history:{}});        
  }
}

let currentGroup = "Alpha";

/* ---- Dynamic distances ---- */
const defaultDistances = ["400","500","800","1000","1200","1500"];
let distances = JSON.parse(localStorage.getItem("distances") || "null") || [...defaultDistances];

function saveDistances(){ localStorage.setItem("distances", JSON.stringify(distances)); }

/* Points remain same */
const points = {
  1:1000,2:816,3:666,4:543,5:443,
  6:362,7:295,8:241,9:196,10:160,
  11:130,12:106,13:86,14:70,15:57
};

function saveData(){ localStorage.setItem("groupsData",JSON.stringify(groups)); }

/* ==================================================
      EXCEL UPLOAD (with heading)
=================================================== */
function uploadExcel(){
  let file=document.getElementById("excelFile").files[0];
  if(!file)return alert("Please select an Excel file.");

  let reader=new FileReader();
  reader.onload=function(e){
    let data=new Uint8Array(e.target.result);
    let workbook=XLSX.read(data,{type:'array'});

    let sheetNames=["Club","Clubs","Divisions"];
    let headingText="";
    for (let s of sheetNames){
      let sheet=workbook.Sheets[s];
      if(!sheet) continue;
      let a1 = sheet["A1"] ? String(sheet["A1"].v).trim() : "";
      if(a1.length > 10){ headingText=a1; break; }
    }
    if(headingText){
      let h=document.getElementById("excelHeading");
      h.textContent=headingText;
      h.style.display="block";
    }

    let sheet=workbook.Sheets["Divisions"];
    if(!sheet)return showExcelErrorPopup();

    let rows=XLSX.utils.sheet_to_json(sheet,{header:1});
    let detectedGroup=null;
    let addedCount=0;

    for(let r=0;r<rows.length;r++){
      let row=rows[r];
      if(!row)continue;

      let cell=row[7];
      if(typeof cell==="string"){
        let G=cell.trim().toUpperCase();
        if(validGroups.includes(G)){
          detectedGroup=G.charAt(0)+G.slice(1).toLowerCase();
          continue;
        }
      }

      let cells=[
        (row[1]||"").toString().trim(),
        (row[2]||"").toString().trim(),
        (row[3]||"").toString().trim(),
        (row[4]||"").toString().trim()
      ];

      let combined=(cells.join(" ").toUpperCase()).replace(/\s+/g," ").trim();
      let headerBlacklist=["FIRST","LAST","FULL","NAME","SKATER","ATHLETE","COMPETITOR","PARTICIPANT"];
      if(headerBlacklist.some(h=>combined.includes(h))) continue;

      let name=null;
      if(isName(cells[0]) && isName(cells[1])) name=cells[0]+" "+cells[1];
      else if(isName(cells[1]) && isName(cells[2])) name=cells[1]+" "+cells[2];
      else if(isName(cells[2]) && isName(cells[3])) name=cells[2]+" "+cells[3];

      if(name && detectedGroup){
        name=name.replace(/[0-9]/g,"").replace(/\s+/g," ").trim();
        addSkaterToGroup(name,detectedGroup);
        addedCount++;
      }
    }

    if(addedCount===0) showExcelErrorPopup();
    else { saveData(); loadGroupTable(); }
  };

  reader.readAsArrayBuffer(file);
}

/* ==================================================
      RESET (with distances reset on Reset All)
=================================================== */
function resetGroup(){
  showConfirm("Reset this group?", function(yes){
    if(!yes)return;
    groups[currentGroup]={skaters:[],history:{}};
    saveData();
    loadGroupTable();
  });
}

function resetAll(){
  showConfirm("Reset all groups and distances?", function(yes){
    if(!yes)return;
    ["Alpha","Bravo","Charlie","Delta","Echo","Foxtrot","Golf","Hotel","India"]
    .forEach(g=>groups[g]={skaters:[],history:{}});

    saveData();
    distances=[...defaultDistances];
    saveDistances();
    loadGroupTable();
  });
}

/* ==================================================
      ADD SKATER
=================================================== */
function addManual(){
  let name=document.getElementById("skaterName").value.trim();
  if(!name)return;

  let g=document.getElementById("addGroupSelect").value;
  addSkaterToGroup(name,g);
  document.getElementById("skaterName").value="";
}

function addSkaterToGroup(name,group){
  let G=groups[group];
  if(!G.skaters.includes(name)){
    G.skaters.push(name);
    let distHistoryObj = {};
    distances.forEach(d=>distHistoryObj[d]=[]);
    G.history[name]={ distHistory: distHistoryObj, stack:[] };
  }
  saveData();
  if(group===currentGroup) loadGroupTable();
}

/* ==================================================
      VIEW GROUP
=================================================== */
function switchGroup(){
  currentGroup=document.getElementById("viewGroupSelect").value;
  loadGroupTable();
}

/* ==================================================
      HEADER ROW (dynamic)
=================================================== */
function buildHeaderRow(){
  let row = document.getElementById("headerRow");
  row.innerHTML = "<th>Name</th>";
  distances.forEach(d=>{ row.innerHTML += "<th>"+d+"</th>"; });
  row.innerHTML += "<th>Total</th><th>Rank</th><th>Undo / Delete</th>";
}

/* ==================================================
      TABLE BUILD (dynamic distances)
=================================================== */
function loadGroupTable() {
  buildHeaderRow();

  let tbody = document.querySelector("#scoreTable tbody");
  tbody.innerHTML = "";

  let groupData = groups[currentGroup];

  groupData.skaters.forEach(name => {
    let row = document.createElement("tr");
    row.dataset.name = name;

    let html = `<td class="name" onclick="openEditName('${name}')">${name}</td>`;
    distances.forEach(()=>{ html += "<td></td>"; });

    html += `
      <td class="total">0</td>
      <td class="rank">-</td>
      <td>
        <button class="btnDangerOutline" onclick="undo('${name}')">Undo</button>
        <button class="btnDangerOutline" onclick="deleteSkater('${name}')">Delete</button>
      </td>
    `;

    row.innerHTML = html;

    distances.forEach((dist, i) => {
      let cell = row.children[i + 1];
      let dd = createDropdown(name, dist);
      cell.appendChild(dd);
    });

    tbody.appendChild(row);
  });

  rebuildDropdowns();

  groupData.skaters.forEach(name => {
    let row = document.querySelector(`tr[data-name="${name}"]`);
    let history = groups[currentGroup].history[name];
    if(!history) return;

    distances.forEach(dist => {
      let dd = row.querySelector(`select[data-dist="${dist}"]`);
      if(!dd) return;

      let stack = history.stack || [];
      let lastEntry = [...stack].reverse().find(s => s.dist === dist);

      if (lastEntry && lastEntry.current !== "") {
        dd.value = lastEntry.current;
        dd.setAttribute("data-last", lastEntry.current);
      } else {
        dd.value = "";
        dd.setAttribute("data-last", "");
      }
    });
  });

  updateScores();
}

/* ==================================================
      DROPDOWNS
=================================================== */
function createDropdown(name,dist){
  let dd=document.createElement("select");
  dd.className="position";
  dd.setAttribute("data-dist", dist);

  dd.innerHTML=`<option value="">-</option>`;
  let count=groups[currentGroup].skaters.length;

  for(let i=1;i<=count;i++) dd.innerHTML+=`<option>${i}</option>`;

  dd.onchange = () => {
    let prevVal = dd.getAttribute("data-last") || "";
    let newVal = dd.value;

    if(!groups[currentGroup].history[name]){
      groups[currentGroup].history[name] = {distHistory:{},stack:[]};
    }

    groups[currentGroup].history[name].stack.push({
      dist: dist,
      prev: prevVal,
      current: newVal
    });

    dd.setAttribute("data-last", newVal);

    updateScores();
    saveData();
  };

  return dd;
}

function rebuildDropdowns(){
  let count=groups[currentGroup].skaters.length;

  document.querySelectorAll("select.position").forEach(dd=>{
    let old=dd.value;
    dd.innerHTML=`<option value="">-</option>`;
    for(let i=1;i<=count;i++) dd.innerHTML+=`<option>${i}</option>`;
    dd.value=old;
  });
}

/* ==================================================
      SCORE + SORT + MEDALS
=================================================== */
function updateScores(){
  let tbody=document.querySelector("#scoreTable tbody");
  let rows=[...tbody.querySelectorAll("tr")];

  rows.forEach(row=>{
    let total=0;
    row.querySelectorAll("select.position").forEach(dd=>{
      let pos=Number(dd.value);
      if(points[pos]) total+=points[pos];
    });
    row.querySelector(".total").textContent=total;
  });

  let scored=rows.filter(r=>Number(r.querySelector(".total").textContent)>0);
  let unscored=rows.filter(r=>Number(r.querySelector(".total").textContent)===0);

  scored.sort((a,b)=>
    Number(b.querySelector(".total").textContent) -
    Number(a.querySelector(".total").textContent)
  );

  tbody.innerHTML="";
  scored.forEach(r=>tbody.appendChild(r));
  unscored.forEach(r=>tbody.appendChild(r));

  scored.forEach((row,index)=>{
    let rank=index+1;
    let nm=row.dataset.name;

    if(rank===1) row.querySelector(".name").innerHTML="ü•á "+nm;
    else if(rank===2) row.querySelector(".name").innerHTML="ü•à "+nm;
    else if(rank===3) row.querySelector(".name").innerHTML="ü•â "+nm;
    else row.querySelector(".name").innerHTML=nm;

    row.querySelector(".rank").textContent=rank;
  });

  unscored.forEach(r=>{
    r.querySelector(".name").innerHTML=r.dataset.name;
    r.querySelector(".rank").textContent="-";
  });
}

/* ==================================================
      UNDO
=================================================== */
function undo(name){
  let h=groups[currentGroup].history[name];
  if(!h || h.stack.length===0)return;

  let last=h.stack.pop();
  let dist=last.dist;
  let prev=last.prev;

  let row=document.querySelector(`tr[data-name="${name}"]`);
  let dd=row.querySelector(`select[data-dist="${dist}"]`);

  dd.value=prev;
  dd.setAttribute("data-last",prev);

  updateScores();
  saveData();
}

/* ==================================================
      DELETE SKATER
=================================================== */
function deleteSkater(name){
  groups[currentGroup].skaters =
    groups[currentGroup].skaters.filter(n=>n!==name);

  if(groups[currentGroup].history[name]){
    delete groups[currentGroup].history[name];
  }

  saveData();
  loadGroupTable();
}

/* ==================================================
      EDIT NAME
=================================================== */
let nameBeingEdited=null;

function openEditName(name){
  nameBeingEdited=name;
  document.getElementById("editNameInput").value=name;
  document.getElementById("editNamePopup").style.display="block";
}

function closeEditName(){
  document.getElementById("editNamePopup").style.display="none";
  nameBeingEdited=null;
}

function saveEditedName(){
  let newName=document.getElementById("editNameInput").value.trim();
  if(!newName)return;

  let g=groups[currentGroup];
  let idx=g.skaters.indexOf(nameBeingEdited);
  if(idx!==-1) g.skaters[idx]=newName;

  g.history[newName]=g.history[nameBeingEdited];
  delete g.history[nameBeingEdited];

  saveData();
  closeEditName();
  loadGroupTable();
}

/* ==================================================
      HELP
=================================================== */
function openHelp(){ document.getElementById("helpPopup").style.display="block"; }
function closeHelp(){ document.getElementById("helpPopup").style.display="none"; }

/* ==================================================
      ACTIONS + DISTANCE POPUPS
=================================================== */
function openActionsPopup(){ document.getElementById("actionsPopup").style.display="flex"; }
function closeActionsPopup(){ document.getElementById("actionsPopup").style.display="none"; }

function openDistancePopup(){ document.getElementById("distancePopup").style.display="flex"; }
function closeDistancePopup(){ document.getElementById("distancePopup").style.display="none"; }

function openDistanceFromActions(){ closeActionsPopup(); openDistancePopup(); }
function openManageFromActions(){ closeActionsPopup(); openManageDistances(); }

function saveNewDistance(){
  let d = document.getElementById("newDistanceInput").value.trim();
  if(!d){ alert("Enter a distance (numbers only)"); return; }
  if(distances.includes(d)){ alert("Distance already exists."); return; }

  distances.push(d);
  saveDistances();

  Object.keys(groups).forEach(gName=>{
    let g = groups[gName];
    Object.keys(g.history).forEach(skater=>{
      if(g.history[skater].distHistory && !g.history[skater].distHistory[d]){
        g.history[skater].distHistory[d]=[];
      }
    });
  });

  document.getElementById("newDistanceInput").value = "";
  closeDistancePopup();

  loadGroupTable();
  alert("Distance "+d+" added!");
}

function openManageDistances(){
  const popup = document.getElementById("manageDistancesPopup");
  const list = document.getElementById("distancesList");
  list.innerHTML = "";

  distances.forEach((d, idx) => {
    const row = document.createElement("div");
    row.className = "distanceRow";
    row.innerHTML = `
      <input type="text"
             value="${d}"
             data-index="${idx}"
             oninput="this.value=this.value.replace(/[^0-9]/g,'');">
      <button class="btnDangerOutline" onclick="deleteDistance(${idx})">Delete</button>
    `;
    list.appendChild(row);
  });

  popup.style.display = "flex";
}

function closeManageDistances(){
  document.getElementById("manageDistancesPopup").style.display="none";
}

function deleteDistance(idx){
  distances.splice(idx,1);
  if(distances.length === 0){
    distances = [...defaultDistances];
  }
  saveDistances();
  openManageDistances();
}

function saveManagedDistances(){
  const inputs = document.querySelectorAll("#distancesList input");
  let newDists = [];

  inputs.forEach(inp => {
    let v = inp.value.trim();
    if(v) newDists.push(v);
  });

  if(newDists.length === 0){
    alert("At least one distance is required. Restoring defaults.");
    newDists = [...defaultDistances];
  }

  distances = newDists;
  saveDistances();

  Object.keys(groups).forEach(gName=>{
    let g = groups[gName];
    Object.keys(g.history).forEach(skater=>{
      let h = g.history[skater];
      if(!h.distHistory) h.distHistory = {};
      distances.forEach(d=>{
        if(!h.distHistory[d]) h.distHistory[d] = [];
      });
    });
  });

  closeManageDistances();
  loadGroupTable();
}

/* ==================================================
      üéÅ PAYPAL POPUP
=================================================== */
function openPaypalPopup(){ document.getElementById("paypalPopup").style.display = "flex"; }
function closePaypalPopup(){ document.getElementById("paypalPopup").style.display = "none"; }

/* ==================================================
      INITIAL LOAD
=================================================== */
loadGroupTable();
</script>

</body>
</html>
